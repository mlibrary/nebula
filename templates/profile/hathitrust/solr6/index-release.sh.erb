#! /bin/bash

TODAY=`date +%Y-%m-%d`
#TODAY="2019-08-31"

BASE=/htsolr/<%= @solr_name %>
SYMLINKBASE=/htsolr/serve
SNAP=".snapshot/<%= @snapshot_name %>_${TODAY}"
CORES="<%= @solr_cores.join(' ') %>"

# check if the administrative release stop flag is set
if [ -f ${BASE}/flags/<%= @solr_stop_flag %> ]; then
  /bin/echo "<%= @solr_stop_flag %> flag present...skip release today"
  exit 1
fi

# check that today's snap exists
for s in $CORES; do
  if [ ! -d $BASE/cores/${s}/${SNAP} ]; then
    /bin/echo "missing today's snapshot...aborting release"
    exit 1
  fi
done

# check today's snap for 'busy' flag
if [ -f $BASE/flags/${SNAP}/busy ]; then
  /bin/echo "indexing and/or optimization ocurring...skip release today"
  exit 1
fi

<% if not @is_primary_site %>#<% end %># check whether release happened at mirror site
<% if not @is_primary_site %>#<% end %>if ! curl -A SOLR -s --retry 5 --fail https://babel.hathitrust.org/flags/web/<%= @solr_name %>-release-${TODAY} --resolve "babel.hathitrust.org:443:<%= @mirror_site_ip %>" >& /dev/null; then
<% if not @is_primary_site %>#<% end %>  /bin/echo "Mirror site index release appears to have failed...skip release today"
<% if not @is_primary_site %>#<% end %>  exit 1
<% if not @is_primary_site %>#<% end %>fi

for s in $CORES; do
  SEGMENTS=`ls ${BASE}/cores/${s}/${SNAP}/<%= @core_data_dir_template %>/index/*.fdt | wc -l`
  if [ ${SEGMENTS} -lt 1 ] || [ ${SEGMENTS} -gt 2 ]; then
    /bin/echo "at least one core served by `hostname -s` has an improper number of segments...aborting release"
    exit 1
  fi
done

# stop solr
systemctl stop solr
if [ $? -ne 0 ]; then
  /bin/echo "error stopping lss solr on `hostname -s`"
  exit 1
fi

# replace the snapshot symlinks
<% if not @is_lss %>#<% end %>rm -f ${SYMLINKBASE}/lss-shared && ln -s ${BASE}/shared/${SNAP} ${SYMLINKBASE}/lss-shared
<% if not @is_lss %>#<% end %>if [ $? -ne 0 ]; then
<% if not @is_lss %>#<% end %>    /bin/echo "error removing or creating /htsolr/serve/lss-shared symlink...solr-current-lss WILL NOT be started on `hostname -s`"
<% if not @is_lss %>#<% end %>    exit 1
<% if not @is_lss %>#<% end %>fi
for s in ${CORES}; do
  rm -f ${SYMLINKBASE}/<%= @core_link_prefix %>${s} && ln -s ${BASE}/cores/${s}/${SNAP} ${SYMLINKBASE}/<%= @core_link_prefix %>${s}
  if [ $? -ne 0 ]; then
    /bin/echo "error removing or creating symlink for core ${s}...solr-current-lss WILL NOT be started on `hostname -s`"
    exit 1
  fi
done

# if all went well, start solr
systemctl start solr
if [ $? -ne 0 ]; then
  /bin/echo "error starting solr on `hostname -s`"
  exit 1
fi

<% if not @is_primary_node %>#<% end %># touch release flag (only on first core/node, so it happens once per datacenter)
<% if not @is_primary_node %>#<% end %>rm -f /htapps/babel/flags/web/<%= @release_flag_prefix %><%= @solr_name %>-release-*
<% if not @is_primary_node %>#<% end %>touch /htapps/babel/flags/web/<%= @release_flag_prefix %><%= @solr_name %>-release-${TODAY}

<% if not @is_lss %>#<% end %># run the first query to initialize lss solr
<% if not @is_lss %>#<% end %>INITQUERY=0
<% if not @is_lss %>#<% end %>for s in $CORES; do
<% if not @is_lss %>#<% end %>  sleep 5
<% if not @is_lss %>#<% end %>  if ! wget -q -T 60 -t 5 -O - "http://solr-sdr-search-${s}:8081/solr/core-${s}x/select/?q=aardvark&version=2.2&start=0&rows=10&indent=on" >& /dev/null; then
<% if not @is_lss %>#<% end %>    /bin/echo "WARN: failed to perform initial query against core ${s}x after successful release"
<% if not @is_lss %>#<% end %>    INITQUERY=1
<% if not @is_lss %>#<% end %>  fi
<% if not @is_lss %>#<% end %>  if ! wget -q -T 60 -t 5 -O - "http://solr-sdr-search-${s}:8081/solr/core-${s}y/select?indent=on&q=*:*&rows=0" >& /dev/null; then
<% if not @is_lss %>#<% end %>    /bin/echo "WARN: failed to perform initial query against core ${s}y after successful release"
<% if not @is_lss %>#<% end %>    INITQUERY=1
<% if not @is_lss %>#<% end %>  fi
<% if not @is_lss %>#<% end %>done
<% if not @is_lss %>#<% end %>
<% if not @is_lss %>#<% end %><% if not @is_primary_node %>#<% end %># cache warming, after delay to avoid racing with other nodes
<% if not @is_lss %>#<% end %><% if not @is_primary_node %>#<% end %>sleep 30
<% if not @is_lss %>#<% end %><% if not @is_primary_node %>#<% end %>/usr/bin/wget -nv -i ${BASE}/prep/cacheWarm169Common.txt -O - 2>/tmp/cache-warming-lss.log 1>/dev/null
<% if not @is_lss %>#<% end %><% if not @is_primary_node %>#<% end %>rm -f /htapps/babel/flags/web/<%= @release_flag_prefix %>lss-warming-*
<% if not @is_lss %>#<% end %><% if not @is_primary_node %>#<% end %>touch /htapps/babel/flags/web/<%= @release_flag_prefix %>lss-warming-${TODAY}
<% if not @is_lss %>#<% end %>
<% if not @is_lss %>#<% end %>exit ${INITQUERY}

<% if not @is_catalog %>#<% end %># run the first query to initialize catalog solr
<% if not @is_catalog %>#<% end %>sleep 5
<% if not @is_catalog %>#<% end %>if ! wget -q -T 60 -t 5 -O - "http://solr-sdr-catalog:9033/solr/catalog/select?q=*:*" >& /dev/null; then
<% if not @is_catalog %>#<% end %>  /bin/echo "WARN: failed to perform initial query after successful release"
<% if not @is_catalog %>#<% end %>  exit 1
<% if not @is_catalog %>#<% end %>fi
