# Managed by puppet (nebula/profile/haproxy/backends.cfg.erb)
<% @frontends.to_a.sort.each do |frontend, node_names| %>
<% nodes = node_names.sort
  .map{|node_id| scope.call_function('fact_for', [node_id, 'networking'])}
  .map{|networking| [networking['hostname'], networking['ip']]}
-%>
backend <%= frontend %>-<%= @datacenter %>-http-back
  http-check expect status 200
<% nodes.each do |hostname, ip| -%>
  <%= "server #{hostname} #{ip}:80 check cookie s#{ip.split('.').last}" %>
<% end -%>

backend <%= frontend %>-<%= @datacenter %>-https-back
  http-check expect status 200
<% nodes.each do |hostname, ip| -%>
  <%= "server #{hostname} #{ip}:443 check cookie s#{ip.split('.').last}" %>
<% end -%>
<% end -%>
